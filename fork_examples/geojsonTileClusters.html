<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Geojson Tile clusters</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='./scripts/mapConstants.js'></script>
    <script src='./scripts/soqlTileUrlSubstitute.js'></script>
    <script src='../dist/mapbox-gl.js'></script>
    <link href='../dist/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>

<div id='map'></div>
<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiYmVuamFtaW4td3lzcyIsImEiOiJVcm5FdEw4In0.S8HRIEq8NqdtFVz2-BwQog';

  var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v9',
      zoom: 11,
      center: [-122.411,37.771],
      // -----------------------------  //
      // Required to work with fork     //
      "transformRequest": substituteSoqlParams
      // -----------------------------  //
  });

  var tileUrl = 'https://dataspace.demo.socrata.com/resource/r6t9-rak2.geojson?$query=' +
        'select count(*),snap_to_grid(point,{snap_precision}) ' +
        'where  {{\'point\' column condition}}' +
        'group by snap_to_grid(point,{snap_precision})' +
        'limit 100000' +
        '#substituteSoqlParams_tileParams={z}|{x}|{y}';

  map.showTileBoundaries = true;
  map.on('load', function () {
    map.addSource('vectorDataSource', {
        "type": "vector",
        "cluster": true,
        "clusterRadius": 80,
        "aggregateBy": 'count',
        "tiles": [ tileUrl ],
        // -----------------------------  //
        // Required to work with fork     //
        "soqlTile": true,
        // -----------------------------  //
    });

    map.addLayer({
      'id': 'pointLayer',
      'type': 'circle',
      'source': 'vectorDataSource',
      'source-layer': '_geojsonTileLayer',
      'cluster': true,
      'clusterRadius': 20,

      'paint': {
          'circle-radius': 20,
          'circle-color': '#288dc1 ',
          "circle-opacity": 0.5
      }
    });
    map.addLayer({
      id: "cluster-count",
      type: "symbol",
      'source': 'vectorDataSource',
      'source-layer': '_geojsonTileLayer',
      'filter': ['all', ['has', 'point_count']],
      layout: {
          "text-field": "{sum}",
          "text-size": 12
      }
    });

    map.addLayer({
      id: "cluster-singles",
      type: "symbol",
      'source': 'vectorDataSource',
      'source-layer': '_geojsonTileLayer',
      'filter': ['all', ['!has', 'point_count']],
      layout: {
          "text-field": "{count}",
          "text-size": 12
      }
    });
  });
</script>

</body>
</html>
